<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Printer Helper</title>
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
</head>

<body style="background: white;">
  <div class="mx-auto pt-5" style="width: 800px; height: 600;">
    <table class="table table-borderless">
      <colgroup>
        <col width="20%">
        <col width="15%">
        <col width="50%">
        <col width="*%">
      </colgroup>
      <tbody>
        <tr>
          <td>총페이지</td><td></td>
          <td><input type="text" class="form-control" id="input_total_page" /></td>
          <td></td>
        </tr>
        <tr>
          <td>더할 페이지(로마자)</td><td></td>
          <td><input type="text" class="form-control" id="input_add_page" value="0" /></td>
          <td></td>
        </tr>
        <tr>
          <td>컬러페이지</td><td id="color_page_count"></td>
          <td><input type="text" class="form-control" id="input_color_page" /></td>
          <td>
    				<div class="custom-control custom-checkbox">
              <input type="checkbox" id="jb-checkbox" class="custom-control-input">
              <label class="custom-control-label" for="jb-checkbox">양면출력</label>
            </div>
          </td>
        </tr>
        <tr>
          <td></td><td></td>
          <td id="re_color_page_info"></td>
          <td></td>
        </tr>
        <tr>
          <td>흑백페이지</td><td id="black_page_count"></td>
          <td><input type="text" class="form-control" id="input_black_page" /></td>
          <td><button id="copy" type="button" class="btn btn-primary btn-sm btn-block">복사하기</button></td>
        </tr>
        <tr>
          <td>파일이름</td><td></td>
          <td><input type="text" class="form-control" id="save_title" /></td>
          <td><a href="#" id="saved_btn" class="btn btn-primary btn-sm btn-block disabled" tabindex="-1" role="button" aria-disabled="true">저장</a></td>
        </tr>
        <tr>
          <td></td><td></td>
          <td></td>
          <td><button id="load" type="button" class="btn btn-primary btn-sm btn-block" onclick="popup_load_page()">불러오기</button></td>
        </tr>
      </tbody>
    </table>
    <div id="image_section" style="text-align:right; margin-right: 30px;" >
      <img src="./asset/background.png" width="100px;"/>
    </div>
  </div>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<script>window.$ = window.jQuery = require('jquery');</script>
<!-- <script type="text/javascript" src="./util/jquery-3.5.1.min.js"></script> -->
<script type="text/javascript" src="./helper.js"></script>
<script type="text/javascript" src="./db.js"></script>
<script type="text/javascript">
  print_helper = new Helper();
  db = new DB();
  var child_window = null

  function popup_load_page() {
    var top = window.screenY;
    var left = window.screenX + 800;

    var options = 'top=' + top + ', left=' + left + ', width=500, height=600, status=no, menubar=no, toolbar=no, resizable=no';
    child_window = window.open("load_page.html", "Load", options, false);
  }

  $("#input_total_page").focusout(function() {
    print_helper.total_page_count = parseInt($("#input_total_page").val());
    refresh();
  });

  $("#input_add_page").focusout(function() {
    print_helper.add_page_count = parseInt($("#input_add_page").val());
    refresh();
  });

  $("#input_color_page").focusout(function() {
    print_helper.color_page_str = $("#input_color_page").val();
    refresh();
  });

  $("#jb-checkbox").click(function() {
    print_helper.double_option = $("#jb-checkbox").is(":checked");
    refresh();
  });

  $("#copy").click(function() {
    var copy_test = document.getElementById("input_black_page");
    copy_test.select();
    copy_test.setSelectionRange(0, 99999);
    document.execCommand("copy");

    alert("복사 되었습니다.");
  });

  $("#save_title").keyup(function() {
    var is_disabled = $("#saved_btn").hasClass("disabled")
    var text_length = $("#save_title").val().length
    if(text_length == 0 && !is_disabled) {
      $("#saved_btn").addClass("disabled")
    }else if (text_length != 0 && is_disabled ){
      $("#saved_btn").removeClass("disabled")
    }
  })

  $("#saved_btn").click(function() {
    title = $("#save_title").val()
    info = JSON.stringify(print_helper)
    db.save_data(title, info)
    alert("저장되었습니다.")
    $("#saved_btn").addClass("disabled")
  })

  function refresh() {
    try{
      if( print_helper.calculate_all_page() ) {
        $("#input_black_page").val(print_helper.black_page_str);
        $("#color_page_count").html(print_helper.color_page_count+" 페이지");
        $("#black_page_count").html(print_helper.black_page_count+" 페이지");
        $("#re_color_page_info").html(print_helper.re_color_page_str);


        if($('#input_total_page').val() == "") {
          $('#input_total_page').val(print_helper.total_page_count)
        }

        if($('#input_add_page').val() == "0") {
          $('#input_add_page').val(print_helper.add_page_count)
        }

        if($('#input_color_page').val() == "") {
          $('#input_color_page').val(print_helper.color_page_str)
        }

        if(print_helper.double_option ^ $("#jb-checkbox").is(":checked")) {
          $("#jb-checkbox").click()
        }

      }
    }catch(error) {
      $("#input_black_page").val("");
      $("#color_page_count").html("");
      $("#black_page_count").html("");

      $("#re_color_page_info").html(error);
    }
  }

  function popup_close(load_title) {
    if(load_title != "") {
      saved_info = JSON.parse(db.get_title_info(load_title))
      print_helper.total_page_count = saved_info.total_page_count
      print_helper.add_page_count = saved_info.add_page_count
      print_helper.color_page_str = saved_info.color_page_str
      print_helper.double_option = saved_info.double_option

      refresh()
    }

    child_window.close()
  }
</script>
</body>
</html>
